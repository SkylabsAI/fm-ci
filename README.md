Centralized FM CI Setup
=======================

This repository documents and implements our centralized FM CI setup, based on
a standard `bhv` checkout.

The CI configuration for any other FM repository is the following.
```yaml
trigger:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    ORIGIN_CI_COMMIT_SHA: $CI_COMMIT_SHA
    ORIGIN_CI_COMMIT_BRANCH: $CI_COMMIT_BRANCH
    ORIGIN_CI_MERGE_REQUEST_IID: $CI_MERGE_REQUEST_IID
    ORIGIN_CI_MERGE_REQUEST_LABELS: $CI_MERGE_REQUEST_LABELS
    ORIGIN_CI_MERGE_REQUEST_PROJECT_ID: $CI_MERGE_REQUEST_PROJECT_ID
    ORIGIN_CI_MERGE_REQUEST_SOURCE_BRANCH_NAME: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    ORIGIN_CI_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
    ORIGIN_CI_PIPELINE_URL: $CI_PIPELINE_URL
    ORIGIN_CI_PROJECT_TITLE: $CI_PROJECT_TITLE
  trigger:
    project: bedrocksystems/formal-methods/fm-ci
    branch: main
    strategy: depend
```
This means that CI for such a repository simply triggers a pipeline on `fm-ci`
(the current repository), setting some variables identifying the provenance of
the CI request, and parameters like merge request labels. All the variables in
the trigger have their standard name, prefixed with `ORIGIN_`.

## Support for `CI::same-branch`

The `CI::same-branch` label can be set in MRs of any FM repository, and it has
the effect of selecting branches of the same name as the MR branch for all the
FM repositories in the `bhv` checkout, if such a branch exists.

Furthermore, if `fm-ci` (the current repository) has a branch of the same name
(that of the initiating MR branch), then it is also selected. When that is the
case, CI is still triggered via the `main` branch. Hence, **any changes to the
`.gitlab-ci.yml` file should be avoided** since they won't be picked up before
the branch is merged.

Note that the `.gitlab-ci.yml` file is kept as simple as possible, to make the
need for changes as unlikely as possible. It does three things:
- It checkout out another commit of `fm-ci` if necessary.
- It generates the main CI configuration (see next section).
- It triggers a child pipeline with the generated configuration.

## CI Configuration Generation

The main CI configuration is generated by calling:
```sh
dune exec -- ./gen/gen.exe ${CI_JOB_TOKEN} repos.conf gen-config.yml
```
This program takes as input a GitLab token, a configuration file `repos.conf`,
and it outputs a YAML file `gen-config.yml` that is used in a child pipeline.

The configuration file `repos.conf` gives the list of FM repositories, as well
as their relative path in a `bhv` checkout, the name of their main branch, and
the list of FM repositories they depend on.

The generation process is documented in the various OCaml files, the main file
being `gen/gen.ml`.
